{% extends 'base.html' %}
{% block content %}

<h2>ðŸ“¦ Produktverwaltung</h2>

<form method="post" class="row g-3">

    <!-- ================= BASIC INFO ================= -->

    <div class="col-md-4">
        <label class="form-label">Gemeinde *</label>
        <select name="gemeinde" class="form-select" required>
            <option value="">-- Bitte wÃ¤hlen --</option>
            {% for g in gemeinden %}
            <option>{{ g }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Projekt</label>
        <input name="projekt" class="form-control">
    </div>

    <div class="col-md-4">
        <label class="form-label">Einsatzort</label>
        <input list="einsatzorte" name="einsatzort" class="form-control">
        <datalist id="einsatzorte">
            {% for e in einsatzorte %}
            <option>{{ e }}</option>
            {% endfor %}
        </datalist>
    </div>

    <div class="col-md-6">
        <label class="form-label">Produkt *</label>
        <input name="produkt" class="form-control" required>
    </div>

    <div class="col-md-6">
        <label class="form-label">Produktdetails</label>
        <textarea name="produktdetails" class="form-control"></textarea>
    </div>

    <div class="col-md-3">
        <label>Serialnummer</label>
        <input name="serialnummer" class="form-control">
    </div>

    <div class="col-md-3">
        <label>KV-ID</label>
        <input name="kv_id" class="form-control">
    </div>

    <div class="col-md-3">
        <label>Anzahl</label>
        <input type="number" name="anzahl" value="1" min="1" class="form-control">
    </div>

    <div class="col-md-3">
        <label>Hersteller</label>
        <input list="hersteller" name="hersteller" class="form-control">
        <datalist id="hersteller">
            {% for h in hersteller %}
            <option>{{ h }}</option>
            {% endfor %}
        </datalist>
    </div>

    <!-- ================= PRICE SECTION ================= -->

    <hr class="mt-4">

    <div class="col-md-3">
        <label>Einzelpreis netto (â‚¬)</label>
        <input type="number" step="0.01" name="preis_netto" id="preis_netto" class="form-control">
        <small class="text-muted" id="nettoHint"></small>
    </div>

    <div class="col-md-3">
        <label>Einzelpreis brutto (â‚¬)</label>
        <input type="number" step="0.01" name="preis_brutto" id="preis_brutto" class="form-control">
        <small class="text-muted" id="bruttoHint"></small>
    </div>

    <div class="col-md-3">
        <label>MwSt-Satz</label>
        <select name="mwst_satz" id="mwst_satz" class="form-select">
            <option value="19" selected>19 % (Standard)</option>
            <option value="7">7 %</option>
            <option value="0">0 %</option>
            <option value="custom">Benutzerdefiniert</option>
        </select>
    </div>

    <div class="col-md-3">
        <label>Individuelle MwSt (%)</label>
        <input type="number" step="0.01" name="mwst_custom" id="mwst_custom" class="form-control" placeholder="z.B. 21"
            disabled>
    </div>

    <!-- ================= DATES ================= -->

    <hr class="mt-4">

    <div class="col-md-4">
        <label>Bestellt am</label>
        <input type="date" name="bestellt_am" class="form-control">
    </div>

    <div class="col-md-4">
        <label>Geliefert am</label>
        <input type="date" name="geliefert_am" class="form-control">
    </div>

    <div class="col-md-4">
        <label>Ãœbergeben am</label>
        <input type="date" name="uebergeben_am" class="form-control">
    </div>

    <!-- ================= ADDITIONAL ================= -->

    <div class="col-md-6">
        <label>Lieferumfang</label>
        <input name="lieferumfang" class="form-control">
    </div>

    <div class="col-md-6">
        <label>ELO-Nummer</label>
        <input name="elo_nummer" class="form-control">
    </div>

    <!-- ================= GENERAL NOTES ================= -->

    <div class="col-md-12 mt-3">
        <label class="form-label">Allgemeine Bemerkungen</label>
        <textarea name="bemerkungen" class="form-control" rows="2"></textarea>
    </div>

    <!-- ================= TEST SECTION ================= -->

    <hr class="mt-4">
    <h5 class="mt-2">ðŸ”§ FunktionsprÃ¼fung</h5>

    <div class="col-md-4">
        <label class="form-label">FunktionsprÃ¼fung</label>
        <select name="funktionspruefung" class="form-select">
            <option value="">-- keine Angabe --</option>
            <option value="Ja">Ja</option>
            <option value="Nein">Nein</option>
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Getestet am</label>
        <input type="date" name="getestet_am" class="form-control">
    </div>

    <div class="col-md-4">
        <label class="form-label">Getestet von</label>
        <input name="getestet_von" class="form-control">
    </div>

    <div class="col-md-12">
        <label class="form-label">Notiz (zur PrÃ¼fung)</label>
        <textarea name="notiz" class="form-control" rows="2"></textarea>
    </div>

    <div class="col-12 text-end mt-3">
        <button class="btn btn-success">ðŸ’¾ HinzufÃ¼gen</button>
    </div>

</form>

<hr>

<h4>ðŸ“‹ Aktuelle Produkte</h4>

{% include 'tabelle_preview.html' %}

<!-- ================= VAT CALC SCRIPT (UNCHANGED LOGIC) ================= -->

<script>
    const nettoInput = document.getElementById("preis_netto");
    const bruttoInput = document.getElementById("preis_brutto");
    const vatSelect = document.getElementById("mwst_satz");
    const vatCustom = document.getElementById("mwst_custom");

    const nettoHint = document.getElementById("nettoHint");
    const bruttoHint = document.getElementById("bruttoHint");

    let lastEdited = null;

    function getVatRate() {
        if (vatSelect.value === "custom") {
            return parseFloat(vatCustom.value || 0) / 100;
        }
        return parseFloat(vatSelect.value || 0) / 100;
    }

    function calculate() {
        const vat = getVatRate();
        const netto = parseFloat(nettoInput.value);
        const brutto = parseFloat(bruttoInput.value);

        if (lastEdited === "netto" && !isNaN(netto)) {
            bruttoInput.value = (netto * (1 + vat)).toFixed(2);
        }

        if (lastEdited === "brutto" && !isNaN(brutto)) {
            nettoInput.value = (brutto / (1 + vat)).toFixed(2);
        }
    }

    nettoInput.addEventListener("input", () => {
        lastEdited = "netto";
        calculate();
    });

    bruttoInput.addEventListener("input", () => {
        lastEdited = "brutto";
        calculate();
    });

    vatSelect.addEventListener("change", () => {
        vatCustom.disabled = vatSelect.value !== "custom";
        calculate();
    });

    vatCustom.addEventListener("input", calculate);
</script>

{% endblock %}