{% extends 'base.html' %}
{% block content %}
<h2>ğŸ“‹ Inventar Tabelle</h2>

<!-- Toolbar -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <input id="searchBox" type="text" class="form-control w-25" placeholder="ğŸ” Suche...">
    <div>
        <button id="editToggle" class="btn btn-warning">âœï¸ Bearbeiten</button>
        <button id="saveBtn" class="btn btn-success" disabled>ğŸ’¾ Speichern</button>
        <button id="deleteBtn" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        <button id="exportBtn" class="btn btn-outline-primary">ğŸ“¤ Exportieren (CSV)</button>
        <button id="printBtn" class="btn btn-outline-success">ğŸ–¨ï¸ Etiketten drucken</button>
    </div>
</div>

<!-- Scrollable table -->
<div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
    <table id="inventoryTable" class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-success sticky-top">
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>ID</th>
                <th>Code</th>
                <th>Gemeinde</th>
                <th>Einsatzort</th>
                <th>Kategorie</th>
                <th>Produkttyp</th>
                <th>Produktdetails</th>
                <th>Anzahl</th>
                <th>Hersteller</th>
                <th>Lieferant</th>
                <th>Shop-Link</th>
                <th>Preis Netto</th>
                <th>Preis Brutto</th>
                <th>Bezahlt</th>
                <th>Bestellt am</th>
                <th>Geliefert am</th>
                <th>Ãœbergeben am</th>
                <th>Projekt</th>
                <th>Bemerkungen</th>
                <th>Erstellt von</th>
                <th>GeÃ¤ndert von</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr data-id="{{ p[0] }}">
                <td><input type="checkbox" class="row-check"></td>
                {% for v in p %}
                <td contenteditable="false">{{ v or '' }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const table = document.getElementById("inventoryTable");
    const searchBox = document.getElementById("searchBox");
    const editToggle = document.getElementById("editToggle");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const selectAll = document.getElementById("selectAll");
    let editMode = false;

    // --- Toggle edit mode ---
    editToggle.addEventListener("click", () => {
        editMode = !editMode;
        document.querySelectorAll("#inventoryTable td[contenteditable]").forEach(td => {
            td.contentEditable = editMode;
            td.classList.toggle("bg-warning-subtle", editMode);
        });
        saveBtn.disabled = !editMode;
        editToggle.textContent = editMode ? "ğŸ”’ Bearbeiten beenden" : "âœï¸ Bearbeiten";
    });

    // --- Simple search filter ---
    searchBox.addEventListener("keyup", () => {
        const filter = searchBox.value.toLowerCase();
        const rows = table.querySelectorAll("tbody tr");
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
        });
    });

    // --- Select all ---
    selectAll.addEventListener("change", () => {
        const checkboxes = document.querySelectorAll(".row-check");
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
    });

    // --- Delete selected rows ---
    deleteBtn.addEventListener("click", () => {
        const selected = Array.from(document.querySelectorAll(".row-check:checked")).map(cb => cb.closest("tr"));
        if (selected.length === 0) {
            alert("Bitte wÃ¤hlen Sie mindestens eine Zeile zum LÃ¶schen aus.");
            return;
        }

        if (!confirm(`${selected.length} Zeile(n) wirklich lÃ¶schen?`)) return;

        const ids = selected.map(row => row.dataset.id);
        fetch("/delete_rows", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids })
        })
            .then(r => r.json())
            .then(resp => {
                alert(resp.message);
                selected.forEach(r => r.remove());
            })
            .catch(err => alert("Fehler beim LÃ¶schen: " + err));
    });

    // --- Track edits ---
    let changedRows = new Set();

    table.addEventListener("input", (e) => {
        const row = e.target.closest("tr");
        if (row) {
            changedRows.add(row.dataset.id); // mark row as changed
        }
    });

    // --- Save only changed rows ---
    saveBtn.addEventListener("click", () => {
        if (changedRows.size === 0) {
            alert("Keine Ã„nderungen erkannt.");
            return;
        }

        const updates = [];
        changedRows.forEach(id => {
            const row = table.querySelector(`tr[data-id="${id}"]`);
            const cells = Array.from(row.querySelectorAll("td")).slice(1).map(td => td.innerText.trim());
            updates.push(cells);
        });

        fetch("/save_table", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ updates })
        })
            .then(r => r.json())
            .then(resp => {
                alert(resp.message || "Ã„nderungen gespeichert");
                changedRows.clear(); // reset tracker
                location.reload(); // refresh the page
            })
            .catch(err => alert("Fehler beim Speichern: " + err));
    });

    // --- Export CSV ---
    document.getElementById("exportBtn").addEventListener("click", () => {
        const link = document.createElement("a");
        link.href = "/export";
        link.download = "Inventar_Export.csv"; // prompts "Save As" dialog
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    // --- Print selected labels ---
    document.getElementById("printBtn").addEventListener("click", () => {
        const selected = Array.from(document.querySelectorAll(".row-check:checked")).map(cb => cb.closest("tr"));
        if (selected.length === 0) {
            alert("Bitte wÃ¤hlen Sie mindestens eine Zeile zum Drucken aus.");
            return;
        }

        if (!confirm(`${selected.length} Etikett(en) jetzt generieren und herunterladen?`)) return;

        const ids = selected.map(r => r.dataset.id);
        fetch("/print_selected", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids })
        })
            .then(resp => {
                if (resp.ok) return resp.blob();
                throw new Error("Serverfehler");
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Etiketten_Landlieben.zip";
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => alert("Fehler beim Herunterladen: " + err));
    });


</script>

{% endblock %}