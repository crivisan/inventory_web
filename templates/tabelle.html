{% extends 'base.html' %}
{% block content %}

<h2>ğŸ“‹ Inventar Tabelle</h2>

<!-- Toolbar -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <input id="searchBox" type="text" class="form-control w-25" placeholder="ğŸ” Suche...">
    <div>
        <button id="editToggle" class="btn btn-warning">âœï¸ Bearbeiten</button>
        <button id="saveBtn" class="btn btn-success" disabled>ğŸ’¾ Speichern</button>
        <button id="deleteBtn" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        <button id="exportBtn" class="btn btn-outline-primary">ğŸ“¤ Exportieren (CSV)</button>
        <button id="printBtn" class="btn btn-outline-success">ğŸ–¨ï¸ Etiketten drucken</button>
    </div>
</div>

<div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
    <table id="inventoryTable" class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-success sticky-top">
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>Code</th>
                <th>Projekt</th>
                <th>Gemeinde</th>
                <th>Einsatzort</th>
                <th>Kategorie</th>
                <th>Produkt</th>
                <th>Produktdetails</th>
                <th>Serialnummer</th>
                <th>KV-ID</th>
                <th>Einzelpreis Netto</th>
                <th>Einzelpreis Brutto</th>
                <th>MwSt (%)</th>
                <th>Anzahl</th>
                <th>ELO-Nummer</th>
                <th>Geliefert am</th>
                <th>Lieferumfang</th>
                <th>FunktionsprÃ¼fung</th>
                <th>Notiz</th>
                <th>Getestet am</th>
                <th>Getestet von</th>
                <th>Hersteller</th>
                <th>Anschaffungsjahr</th>
                <th>Bestellt am</th>
                <th>Ãœbergeben am</th>
                <th>Bemerkungen</th>
                <th>Erstellt von</th>
                <th>GeÃ¤ndert von</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr data-id="{{ p[0] }}">
                <td><input type="checkbox" class="row-check"></td>
                {% for v in p %}
                <td contenteditable="false">{{ v or '' }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>

    const columns = [
        "code",
        "projekt",
        "gemeinde",
        "einsatzort",
        "kategorie",
        "produkt",
        "produktdetails",
        "serialnummer",
        "kv_id",
        "einzelpreis_netto",
        "einzelpreis_brutto",
        "mwst_satz",
        "anzahl",
        "elo_nummer",
        "geliefert_am",
        "lieferumfang",
        "funktionspruefung",
        "notiz",
        "getestet_am",
        "getestet_von",
        "hersteller",
        "anschaffungsjahr",
        "bestellt_am",
        "uebergeben_am",
        "bemerkungen",
        "erstellt_von",
        "geaendert_von"
    ];

    const table = document.getElementById("inventoryTable");
    const searchBox = document.getElementById("searchBox");
    const editToggle = document.getElementById("editToggle");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const selectAll = document.getElementById("selectAll");

    let editMode = false;
    let changedRows = new Set();


    // ------------------ EDIT TOGGLE ------------------
    editToggle.addEventListener("click", () => {

        editMode = true;

        document.querySelectorAll("#inventoryTable tbody td").forEach(td => {
            td.contentEditable = true;
            td.classList.add("bg-warning-subtle");
        });

        editToggle.disabled = true;     // disable edit button
        saveBtn.disabled = false;       // enable save button
    });


    // ------------------ SEARCH ------------------
    searchBox.addEventListener("keyup", () => {
        const filter = searchBox.value.toLowerCase();
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
        });
    });


    // ------------------ SELECT ALL ------------------
    selectAll.addEventListener("change", () => {
        document.querySelectorAll(".row-check").forEach(cb => {
            cb.checked = selectAll.checked;
        });
    });


    // ------------------ TRACK CHANGES ------------------
    table.addEventListener("input", (e) => {
        const row = e.target.closest("tr");
        if (row) {
            changedRows.add(row.dataset.id);
        }
    });


    // ------------------ SAVE ------------------
    saveBtn.addEventListener("click", () => {

        if (changedRows.size === 0) {
            alert("Keine Ã„nderungen erkannt.");
            return;
        }

        const updates = [];

        changedRows.forEach(code => {
            const row = table.querySelector(`tr[data-id="${code}"]`);
            const cells = Array.from(row.querySelectorAll("td")).slice(1);

            let rowData = {};
            columns.forEach((col, index) => {
                rowData[col] = cells[index]?.innerText.trim() || null;
            });

            updates.push(rowData);
        });

        fetch("/save_table", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ updates })
        })
            .then(r => r.json())
            .then(resp => {

                alert(resp.message || "Ã„nderungen gespeichert");

                changedRows.clear();

                // Exit edit mode
                document.querySelectorAll("#inventoryTable tbody td").forEach(td => {
                    td.contentEditable = false;
                    td.classList.remove("bg-warning-subtle");
                });

                editToggle.disabled = false;
                saveBtn.disabled = true;

                location.reload();
            })
            .catch(err => alert("Fehler beim Speichern: " + err));
    });


    // ------------------ DELETE ------------------
    deleteBtn.addEventListener("click", () => {

        const selected = Array.from(document.querySelectorAll(".row-check:checked"))
            .map(cb => cb.closest("tr"));

        if (selected.length === 0) {
            alert("Bitte wÃ¤hlen Sie mindestens eine Zeile zum LÃ¶schen aus.");
            return;
        }

        if (!confirm(`${selected.length} Zeile(n) wirklich lÃ¶schen?`)) return;

        const ids = selected.map(row => row.dataset.id);

        fetch("/delete_rows", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids })
        })
            .then(r => r.json())
            .then(resp => {
                alert(resp.message);
                selected.forEach(r => r.remove());
            })
            .catch(err => alert("Fehler beim LÃ¶schen: " + err));
    });


    // ------------------ EXPORT ------------------
    document.getElementById("exportBtn").addEventListener("click", () => {
        window.location.href = "/export";
    });


    // ------------------ PRINT ------------------
    document.getElementById("printBtn").addEventListener("click", () => {

        const selected = Array.from(document.querySelectorAll(".row-check:checked"))
            .map(cb => cb.closest("tr"));

        if (selected.length === 0) {
            alert("Bitte wÃ¤hlen Sie mindestens eine Zeile zum Drucken aus.");
            return;
        }

        if (!confirm(`${selected.length} Etikett(en) jetzt generieren und herunterladen?`)) return;

        const ids = selected.map(r => r.dataset.id);

        fetch("/print_selected", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids })
        })
            .then(resp => {
                if (!resp.ok) throw new Error("Serverfehler");
                return resp.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Etiketten_Landlieben.zip";
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => alert("Fehler beim Herunterladen: " + err));
    });

</script>

{% endblock %}